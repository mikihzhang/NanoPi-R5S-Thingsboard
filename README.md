# NanoPi R5Sé…ç½®ä¸ºThingsboardè¿œç¨‹ç›‘æ§å¹³å°æ­¥éª¤ğŸ 

## ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡å·¥ä½œ

å¼€å§‹å‰ï¼Œå‡†å¤‡å¥½ä»¥ä¸‹ç‰©å“

|         microSD å¡          | å®¹é‡ï¼=16GB |
| :-------------------------: | :---------: |
|      nanopi r5så¼€å‘æ¿       |     1ä¸ª     |
|            ç½‘çº¿             |     1æ¡     |
| USB-C ä¾›ç”µçº¿ï¼‹PD ç”µæºé€‚é…å™¨ |     1æ¡     |

ç”µè„‘ä¸Šä¸‹è½½å¥½é•œåƒæ–‡ä»¶å’Œçƒ§å½•è½¯ä»¶Win32 Disk Imager

### 1.1 ä¸‹è½½é•œåƒæ–‡ä»¶

è®¿é—®[ä¸‹è½½é“¾æ¥](http://download.friendlyelec.com/NanoPiR5S)ä¸‹è½½å®˜æ–¹é•œåƒæ–‡ä»¶ï¼ˆä½äºâ€œ01_Official imagesâ€ç›®å½•ï¼‰ã€‚![image-20251016164342664](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20251016164342664.png)

ä¸‹è½½ä¸Šå›¾é•œåƒæ–‡ä»¶ã€‚

### 1.2 ä¸‹è½½çƒ§å½•å·¥å…·

è®¿é—®[ä¸‹è½½é“¾æ¥](http://download.friendlyelec.com/NanoPiR5S)ï¼ˆåœ¨â€œ05_Toolsâ€ç›®å½•ä¸­ï¼‰ä¸‹è½½win32diskimager.rar

![image-20251016163852674](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20251016163852674.png)



## ç¬¬äºŒæ­¥ï¼šçƒ§å½•é•œåƒ

è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

- å°†ä¸€å¼  microSD å¡ï¼›

- è®¿é—®[ä¸‹è½½é“¾æ¥](http://download.friendlyelec.com/NanoPiR5S)ä¸‹è½½é•œåƒæ–‡ä»¶ï¼ˆåœ¨â€œ01_Official images/01_SD card imagesâ€ç›®å½•ä¸‹ï¼‰ï¼›

- è®¿é—®[ä¸‹è½½é“¾æ¥](http://download.friendlyelec.com/NanoPiR5S)ä¸‹è½½win32diskimagerå·¥å…·ï¼ˆåœ¨â€œ05_Toolsâ€ç›®å½•ä¸­ï¼‰ï¼Œæˆ–è€…ä½¿ç”¨æ‚¨å–œæ¬¢çš„å·¥å…·ï¼›

- è§£å‹.gzæ ¼å¼å‹ç¼©æ–‡ä»¶ï¼Œå¾—åˆ°.imgæ ¼å¼é•œåƒæ–‡ä»¶ï¼›

- åœ¨ Windows ç³»ç»Ÿä¸­ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ win32diskimager å®ç”¨ç¨‹åºã€‚åœ¨å®ç”¨ç¨‹åºçš„ä¸»çª—å£ä¸­ï¼Œé€‰æ‹© SD å¡çš„é©±åŠ¨å™¨ã€æ‰€éœ€çš„æ˜ åƒæ–‡ä»¶ï¼Œç„¶åç‚¹å‡»â€œå†™å…¥â€å³å¯å¼€å§‹åˆ·å†™ SD å¡ã€‚

  ![image-20251016165029612](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20251016165029612.png)

- å–å‡ºSDå¡ï¼Œæ’å…¥NanoPi-R5Sçš„microSDå¡æ§½ï¼›

- æ‰“å¼€ NanoPi-R5S ç”µæºï¼Œå®ƒå°†ä»æ‚¨çš„ TF å¡å¯åŠ¨ï¼Œçº¢ç¯å¿«é€Ÿé—ªçƒä»£è¡¨æ­£åœ¨å¯åŠ¨ã€‚ä¸‰ä¸ªç»¿ç¯é•¿äº®åå³å¯å¼¹å‡ºmicroSDå¡ï¼Œå¼€å‘æ¿å°†è‡ªåŠ¨é‡å¯ï¼›



## ç¬¬ä¸‰æ­¥ï¼šç»ˆç«¯æ“ä½œ

### 3.1 è¿œç¨‹ç™»å½•

ä½¿ç”¨ç½‘çº¿å°†Nanopi R5Sçš„å…¶ä¸­ä¸€ä¸ªlanå£è¿æ¥è‡³ç”µè„‘ï¼Œå¹¶è·å–è¯¥è®¾å¤‡çš„IPåœ°å€

Win+Ræ‰“å¼€powershellç»ˆç«¯å‘½ä»¤è¡Œç•Œé¢ã€‚ä½¿ç”¨sshå‘½ä»¤ç™»å½•è¯¥è®¾å¤‡

```bash
ssh pi@10.1.0.154
```

å°†ä¸Šé¢çš„ipåœ°å€æ›¿æ¢ä¸ºä½ å®é™…çš„è®¾å¤‡ï¼Œéšåä¼šå¼¹å‡ºè¾“å…¥å¯†ç ï¼Œé»˜è®¤å¯†ç ä¸ºpi

### 3.2 ç»ˆç«¯å‘½ä»¤

#### 3.2.1 å‡†å¤‡ä¸åŸºç¡€å·¥å…·

æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•å¹¶å®‰è£…å¸¸ç”¨å·¥å…·ï¼ˆnanoã€htop ç­‰ï¼‰

```bash
sudo apt update
```

```bash
sudo apt --fix-broken install -y
sudo apt install -y ca-certificates curl gnupg lsb-release
```

```bash
sudo apt update
sudo apt install -y nano htop
```

#### 3.2.2 è®¾ç½®ä¸­æ–‡ UTF-8 locales & å®‰è£… locales åŒ…

**è¯´æ˜**ï¼šç¡®ä¿ç³»ç»Ÿä½¿ç”¨ä¸­æ–‡ UTF-8ï¼ˆé¿å… Pythonè„šæœ¬ / æ—¥å¿—ä¸­æ–‡ä¹±ç ï¼‰

```bash
sudo apt update
sudo apt install -y locales
sudo locale-gen zh_CN.UTF-8
sudo update-locale LANG=zh_CN.UTF-8
```

**ä½¿å½“å‰ shell ç«‹å³ç”Ÿæ•ˆï¼ˆä¸æƒ³é‡å¯æ—¶ï¼‰**ï¼š

```bash
export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8
```

#### 3.2.3 å®‰è£… Dockerï¼ˆå«å¸¸ç”¨æ’ä»¶ï¼‰ä¸é…ç½®é•œåƒåŠ é€Ÿ

**è¯´æ˜**ï¼šå…ˆå®‰è£…å¿…è¦ä¾èµ–ã€æ·»åŠ é•œåƒæºï¼ˆæ­¤å¤„ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæºï¼‰ï¼Œç„¶åå®‰è£… Docker ä¸ compose æ’ä»¶ã€‚

å…ˆæ›´æ–°å¹¶å®‰è£…ä¾èµ–ï¼š

```bash
sudo apt update
sudo apt upgrade -y
sudo apt install -y apt-transport-https ca-certificates curl software-properties-common gnupg lsb-release
```

å¯¼å…¥ Docker GPGï¼ˆç¤ºä¾‹ï¼šé˜¿é‡Œé•œåƒï¼›å¦‚æœä½ ä½¿ç”¨å®˜æ–¹æºæˆ–å…¶å®ƒé•œåƒè¯·æ›¿æ¢ï¼‰ï¼š

```bash
curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -
```

å‡†å¤‡ trusted.gpg å’Œæ·»åŠ  apt æºï¼ˆæ³¨ï¼šè¯·ç¡®è®¤ `$(lsb_release -cs)` å¯¹åº”ä½ çš„å‘è¡Œç‰ˆä»£å·ï¼‰ï¼š

```bash
sudo cp /etc/apt/trusted.gpg /etc/apt/trusted.gpg.d/
sudo add-apt-repository "deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable"
```

`Press [ENTER] to continue or Ctrl-c to cancel.`

é‡åˆ°ä¸Šè¿°æç¤ºï¼Œç›´æ¥æŒ‰enterå›è½¦é”®ç»§ç»­

å®‰è£… Docker ä¸ç›¸å…³æ’ä»¶ï¼š

```bash
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

å°†å½“å‰ç”¨æˆ·åŠ å…¥ docker ç»„ï¼ˆä½¿æ™®é€šç”¨æˆ·å¯è¿è¡Œ dockerï¼‰ï¼š

```bash
sudo usermod -aG docker $USER
```

**æç¤º**ï¼š`usermod` åéœ€è¦é‡å¯æˆ–é‡æ–°ç™»å½•ä½¿ç»„å˜æ›´ç”Ÿæ•ˆï¼›ä½ å¯ä»¥é‡å¯æœºå™¨æˆ–é€€å‡ºå†ç™»å½•ã€‚

```bash
sudo reboot
```

ç„¶åé‡æ–°é€šè¿‡ SSH ç™»å½•ï¼ˆç¤ºä¾‹ï¼‰ï¼š

```bash
ssh pi@10.1.0.154
```



#### 3.2.4 é…ç½® Docker é•œåƒåŠ é€Ÿä¸æ—¥å¿—ç­–ç•¥ï¼ˆdaemon.jsonï¼‰

**è¯´æ˜**ï¼šåˆ›å»ºæˆ–æ›¿æ¢ `/etc/docker/daemon.json`ï¼Œé…å¤šä¸ª registry mirror å¹¶è®¾ç½®æ—¥å¿—æ»šåŠ¨ç­–ç•¥ã€‚

**æ³¨æ„**ï¼šè¯¥å‘½ä»¤å—åŒ…å«å¤šè¡Œ JSON, å•ç‹¬ä½œä¸ºæ–‡ä»¶å†™å…¥çš„å‘½ä»¤å—ä¸å¯ä¸å…¶å®ƒå‘½ä»¤åˆå¹¶å¤åˆ¶ã€‚

```bash
sudo tee /etc/docker/daemon.json <<-'EOF'
{
    "registry-mirrors": [
        "https://docker.m.daocloud.io",
        "https://mirror.baidubce.com",
        "http://hub-mirror.c.163.com",
        "https://docker.mirrors.ustc.edu.cn",
        "https://docker.hpcloud.cloud",
        "https://docker.unsee.tech",
        "https://docker.1panel.live",
        "http://mirrors.ustc.edu.cn",
        "https://docker.chenby.cn",
        "http://mirror.azure.cn",
        "https://dockerpull.org",
        "https://dockerhub.icu",
        "https://hub.rat.dev",
        "https://proxy.1panel.live",
        "https://docker.1panel.top",
        "https://docker.1ms.run",
        "https://docker.ketches.cn",
        "https://registry.docker-cn.com"
    ],
    "log-driver": "json-file",
    "log-opts": {
        "max-size": "10m",
        "max-file": "3"
    },
    "storage-driver": "vfs"
}
EOF
```

é‡æ–°åŠ è½½ systemd å¹¶é‡å¯ dockerï¼š

```bash
sudo systemctl daemon-reload
sudo systemctl start docker
sudo systemctl enable docker
```

éªŒè¯ docker ä¿¡æ¯ï¼ˆæ£€æŸ¥ `Registry Mirrors`ï¼‰ï¼š

```bash
sudo docker info
```

è¯•è¿è¡Œ hello-world é•œåƒéªŒè¯ Docker æ˜¯å¦æ­£å¸¸ï¼š

```bash
sudo docker run hello-world
```

#### 3.2.5 å®‰è£… Python ä¾èµ– & ä¸²å£ç»„æƒé™

**è¯´æ˜**ï¼šå®‰è£… Python åŒ…ä¸ paho-mqttã€pyserialï¼Œç¡®ä¿èƒ½é€šè¿‡ pip ä½¿ç”¨è¿™äº›åº“ã€‚

```bash
# 1) å®‰è£…åˆ›å»º venv æ‰€éœ€çš„ç³»ç»ŸåŒ…
sudo apt update
sudo apt --fix-broken install
sudo apt install -y python3-venv python3-dev build-essential
```

```bash
# 2) ç¡®è®¤é¡¹ç›®ç›®å½•å­˜åœ¨ï¼Œå¹¶åˆ—å‡ºå†…å®¹
ls -la /opt/serial_to_frp
```

```bash
# 3) åˆ›å»ºæ–°çš„ venvï¼ˆä»¥ system python3 åˆ›å»ºåˆ° /optï¼‰
sudo python3 -m venv /opt/serial_to_frp/venv
```

```bash
# 4) ç¡®ä¿ venv ä¸­æœ‰ pipï¼ˆbootstrapï¼‰
sudo /opt/serial_to_frp/venv/bin/python -m ensurepip --upgrade || true
```

```bash
# 5) å‡çº§ pip/setuptools/wheelï¼ˆåœ¨ venv å†…ï¼‰
sudo /opt/serial_to_frp/venv/bin/python -m pip install --upgrade pip setuptools wheel
```

```bash
# 6) åœ¨ venv å†…å®‰è£…éœ€è¦çš„åŒ…ï¼ˆpyserial, paho-mqttï¼‰
sudo /opt/serial_to_frp/venv/bin/python -m pip install pyserial paho-mqtt
```

```bash
# 7) éªŒè¯ pyserial å¯å¯¼å…¥
sudo /opt/serial_to_frp/venv/bin/python -c "import serial; print('pyserial OK,', getattr(serial,'__version__','unknown'))"

```



éªŒè¯ Python åº“ç‰ˆæœ¬ï¼ˆå•è¡Œå‘½ä»¤ï¼‰ï¼š

```bash
python3 -c "import importlib.metadata as m; print('paho-mqtt:', m.version('paho-mqtt')); print('pyserial:', m.version('pyserial'))"
```

ç»™å½“å‰ç”¨æˆ·ä¸²å£ï¼ˆdialoutï¼‰æƒé™ï¼ˆéœ€é‡æ–°ç™»å½•ç”Ÿæ•ˆï¼‰ï¼š

```bash
sudo usermod -aG dialout $USER
```

```
exit
```

ç„¶åé‡æ–°é€šè¿‡ SSH ç™»å½•ï¼ˆç¤ºä¾‹ï¼‰ï¼š

```bash
ssh pi@10.1.0.154
```

#### 3.2.6 ç”¨ Docker éƒ¨ç½² ThingsBoard CEï¼ˆPostgreSQLï¼ŒæŒä¹…åŒ–ï¼‰

**è¯´æ˜**ï¼šå°† ThingsBoard ç”¨ Docker Compose éƒ¨ç½²ï¼Œæ•°æ®æŒä¹…åŒ–åˆ°å®¿ä¸»æœºç›®å½•ã€‚

åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•å¹¶åˆ›å»ºç›®å½•ç»“æ„ï¼š

```bash
mkdir -p ~/tb-stack
cd ~/tb-stack
```

> è¯¥å‘½ä»¤åŒ…å« YAML å†…å®¹ï¼Œå•ç‹¬ä½œä¸ºæ–‡ä»¶å†™å…¥å‘½ä»¤å—ï¼Œå‹¿ä¸å…¶å®ƒå‘½ä»¤æ··åˆå¤åˆ¶ã€‚

```bash
cat > docker-compose.yml <<'YAML'
services:
  thingsboard:
    image: thingsboard/tb-postgres
    restart: unless-stopped
    ports:
      - "8080:8080"   # â† ç¡®ä¿å­˜åœ¨
      - "9090:9090"
      - "1883:1883"
    environment:
      TB_QUEUE_TYPE: in-memory
      HTTP_BIND_ADDRESS: "0.0.0.0"
      HTTP_BIND_PORT: "8080"
      JAVA_OPTS: "-Xms256m -Xmx512m"
    volumes:
      - ./tb-data:/data
      - ./tb-logs:/var/log/thingsboard
YAML
```



åˆ›å»ºæŒä¹…åŒ–ç›®å½•ä¸æƒé™è®¾ç½®ï¼š

```bash
mkdir -p ~/tb-stack/tb-data ~/tb-stack/tb-logs
```

å°†ç›®å½•æ‰€æœ‰æƒæ”¹ä¸ºå®¹å™¨å†… TB è¿è¡Œçš„ UIDï¼ˆThingsBoard ä½¿ç”¨ UID=799ï¼‰ï¼š

```bash
sudo chown -R 799:799 ~/tb-stack/tb-data ~/tb-stack/tb-logs
```

å¯é€‰ï¼šç»™è¯»å†™æƒé™ä¾¿äºæ’æŸ¥ï¼š

```bash
sudo chmod -R u+rwX,g+rX,o+rX ~/tb-stack/tb-data ~/tb-stack/tb-logs
```

å¤‡ä»½å½“å‰ daemon.jsonï¼ˆä»¥é˜²ï¼‰ï¼š

```bash
sudo mkdir -p /etc/docker
sudo cp /etc/docker/daemon.json /etc/docker/daemon.json.bak 2>/dev/null || true
```

åœ¨ç›®å½•ä¸‹å¯åŠ¨ composeï¼š

```bash
cd ~/tb-stack
sudo docker compose up -d
```

#æŸ¥çœ‹ thingsboard æ—¥å¿—ï¼ˆé¦–å¯ä¼šåˆå§‹åŒ– DBï¼Œç­‰å¾… `Installation finished successfully!`ï¼‰ï¼š

```bash
#docker compose logs -f thingsboard
```

**MQTT å®¢æˆ·ç«¯è‡ªæ£€ï¼ˆæœ¬æœºï¼‰**ï¼š

```bash
sudo apt update
sudo apt install -y mosquitto-clients
```

#### 3.2.7 å®‰è£… frpcï¼ˆSAKURA FRPå®¢æˆ·ç«¯ï¼‰

ç™»å½•[SAKURA FRPå®˜ç½‘](https://www.natfrp.com/)å¹¶ç‚¹å‡»ç®¡ç†é¢æ¿å¯è¿›è¡Œéš§é“ç®¡ç†ï¼Œè´¦æˆ·å`xiaomohaa`å¯†ç `Ap119119`

------

**è¯´æ˜**ï¼šä¸‹è½½å¯¹åº”æ¶æ„ï¼ˆARM64ï¼‰çš„ frpc äºŒè¿›åˆ¶åˆ° `/usr/local/bin`ï¼Œå¹¶è®¾ç½® systemd æ¨¡æ¿å¯ç”¨å¤šä¸ªå®ä¾‹ã€‚

åˆ‡æ¢åˆ° root shellï¼ˆå¯é€‰ï¼‰ï¼š

```bash
sudo -s
```

è¿›å…¥æ”¾ç½®ç›®å½•å¹¶ä½¿ç”¨wgetä¸‹è½½ï¼ˆè¯·ä»¥é¢æ¿ç»™å‡ºçš„ä¸‹è½½åœ°å€ä¸ºå‡†ï¼‰ï¼š

```bash
cd /usr/local/bin
```

```bash
sudo wget -O frpc https://nya.globalslb.net/natfrp/client/frpc/0.51.0-sakura-12.3/frpc_linux_arm64
```

æˆ–ç”¨ curlï¼ˆä»»é€‰å…¶ä¸€ï¼‰ï¼š

```bash
sudo curl -Lo frpc https://nya.globalslb.net/natfrp/client/frpc/0.51.0-sakura-12.3/frpc_linux_arm64
```

æˆæƒå¹¶æ ¡éªŒï¼š

```bash
chmod 755 frpc
ls -ls frpc
md5sum frpc
```

éªŒè¯ç‰ˆæœ¬ï¼ˆè‹¥å‘½ä»¤å¤±è´¥è¯·ç¡®è®¤è·¯å¾„ï¼‰ï¼š

```bash
frpc -v
```

åˆ›å»ºé…ç½®ç›®å½•å¹¶æ£€æŸ¥ï¼š

```bash
sudo mkdir -p /etc/frp
sudo chown root:root /etc/frp
sudo chmod 755 /etc/frp
ls -la /etc/frp
```

ç¡®è®¤ frpc å¯æ‰§è¡Œï¼š

```bash
ls -l /usr/local/bin/frpc || which frpc || echo "frpc æœªæ‰¾åˆ°"
```

#### 3.2.8 åˆ›å»ºä¸¤ä¸ªç‹¬ç«‹çš„ frpc é…ç½®æ–‡ä»¶ï¼ˆtest1.ini / test2.iniï¼‰

**è¯´æ˜**ï¼šæ¯ä¸ª ini å¯¹åº”ä¸€ä¸ª `frpc@<name>.service` systemd å®ä¾‹ã€‚ä»¥ä¸‹ä¸ºå†™å…¥æ–‡ä»¶çš„å‘½ä»¤å—ï¼ˆå•ç‹¬å†™å…¥ï¼‰ã€‚

test1.iniï¼š

```bash
sudo tee /etc/frp/test1.ini > /dev/null <<'EOF'
[common]
user = 78yrqxeswkb5kgshk4ygrnzolzecsagc

sakura_mode = true
login_fail_exit = false

server_addr = frp-rug.com
server_port = 8088

[test1]
type = tcp
local_ip = 127.0.0.1
local_port = 1883
remote_port = 10276
EOF
```

test2.iniï¼š

```bash
sudo tee /etc/frp/test2.ini > /dev/null <<'EOF'
[common]
user = 78yrqxeswkb5kgshk4ygrnzolzecsagc

sakura_mode = true
login_fail_exit = false

server_addr = frp-rug.com
server_port = 8088

[test2]
type = tcp
local_ip = 127.0.0.1
local_port = 8443
remote_port = 63719
EOF
```

è®¾ç½®æƒé™ï¼ˆæ¨è root:rootï¼Œ0644ï¼‰ï¼š

```bash
sudo chown root:root /etc/frp/test1.ini /etc/frp/test2.ini
sudo chmod 644 /etc/frp/test1.ini /etc/frp/test2.ini
ls -l /etc/frp/*.ini
```

åˆ›å»º systemd æ¨¡æ¿å•å…ƒï¼ˆ`frpc@.service`ï¼‰ï¼š

```bash
sudo tee /etc/systemd/system/frpc@.service > /dev/null <<'EOF'
[Unit]
Description=SakuraFrp frpc (%i)
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/frpc -c /etc/frp/%i.ini
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF
```

re-load systemd å¹¶å¯ç”¨/å¯åŠ¨ä¸¤ä¸ªå®ä¾‹ï¼š

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now frpc@test1.service frpc@test2.service
```

æ£€æŸ¥çŠ¶æ€ä¸æ—¥å¿—ï¼š

```bash
sudo systemctl status frpc@test1 --no-pager -l
sudo systemctl status frpc@test2 --no-pager -l
```

#### 3.2.9 å®‰è£…å¹¶é…ç½® Caddyï¼ˆæœ¬åœ° TLS + åå‘ä»£ç†åˆ° ThingsBoardï¼‰

**è¯´æ˜**ï¼šCaddy ç”¨ä½œæœ¬åœ° TLS çš„åå‘ä»£ç†ï¼ˆæŠŠå¤–éƒ¨é€šè¿‡ frp è½¬å‘æ¥çš„ 8443 è¯·æ±‚åä»£åˆ°æœ¬æœº 8080ï¼‰ã€‚

å®‰è£…å‰å‡†å¤‡ï¼ˆæ·»åŠ ä»“åº“å¯†é’¥å¹¶å®‰è£…ï¼‰ï¼š

```bash
sudo apt update
sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https
```

å¯¼å…¥ GPG å¹¶æ·»åŠ  Caddy æºï¼š

```bash
# 1. å¦‚æœç›®å½•ä¸å­˜åœ¨å°±åˆ›å»º
sudo mkdir -p /usr/share/keyrings

# 2. ä¸‹è½½å¹¶ dearmorï¼ˆæ¨èï¼šç”ŸæˆäºŒè¿›åˆ¶ keyringï¼‰
curl -fsSL https://dl.cloudsmith.io/public/caddy/stable/gpg.key \
  | gpg --dearmor \
  | sudo tee /usr/share/keyrings/caddy-stable-archive-keyring.gpg >/dev/null
```

å®‰è£… Caddyï¼š

```bash
sudo apt update
sudo apt install -y caddy
```

**åˆ›å»º Caddyfileï¼ˆå•ç‹¬å†™å…¥æ–‡ä»¶ï¼‰**ï¼š

```bash
sudo tee /etc/caddy/Caddyfile > /dev/null <<'EOF'

# Caddy åä»£ ThingsBoardï¼ˆæŠŠä¸‹é¢åŸŸåæ¢æˆä½ å®é™…çš„ frp åŸŸåï¼‰
frp-rib.com:8443 {
    reverse_proxy 127.0.0.1:8080
    tls internal
}

frp-rug.com:8443 {
    reverse_proxy 127.0.0.1:8080
    tls internal
}

# æœ¬åœ°è°ƒè¯•å¤‡ç”¨
localhost:8443 {
    reverse_proxy 127.0.0.1:8080
    tls internal
}

127.0.0.1:8443 {
    reverse_proxy 127.0.0.1:8080
    tls internal
}

EOF
```

é‡è½½å¹¶é‡å¯ Caddy æœåŠ¡ï¼š

```bash
sudo systemctl daemon-reload

sudo systemctl restart caddy
#æœåŠ¡åˆæ¬¡å¯åŠ¨æ—¶è¯·ä½¿ç”¨ sudo systemctl start caddy
```

æŸ¥çœ‹ Caddy çŠ¶æ€ä¸æ—¥å¿—ï¼ˆå¿«é€ŸæŸ¥çœ‹æœ€è¿‘æ—¥å¿—ï¼‰ï¼š

```bash
sudo systemctl status caddy --no-pager -l
sudo journalctl -u caddy -n 80 --no-pager
```

å¯¼å‡º Caddy æœ¬åœ° CA æ ¹è¯ä¹¦åˆ°ç³»ç»Ÿè¯ä¹¦å­˜å‚¨å¹¶æ›´æ–°è¯ä¹¦å­˜å‚¨ï¼ˆDebian/Ubuntuï¼‰ï¼š

```bash
sudo cp /var/lib/caddy/.local/share/caddy/pki/authorities/local/root.crt /usr/local/share/ca-certificates/Caddy_Local_Authority.crt
sudo chmod 644 /usr/local/share/ca-certificates/Caddy_Local_Authority.crt
sudo update-ca-certificates
```

æœ¬æœº TLS éªŒè¯ï¼ˆä½¿ç”¨ opensslï¼‰ï¼š

```bash
openssl s_client -connect 127.0.0.1:8443 -servername localhost -showcerts </dev/null 2>&1 | sed -n '1,240p'
```

ç”¨ curl æµ‹è¯•é€šè¿‡ SNI è®¿é—®ï¼ˆæŠŠåŸŸåè§£æåˆ° 127.0.0.1ï¼‰ï¼š

```bash
curl -vk --resolve frp-rug.com:8443:127.0.0.1 https://frp-rug.com:8443/ -o /dev/null -w "%{http_code}
"
```

#### 3.2.10 ä¸²å£é‡‡é›†è„šæœ¬ï¼ˆserial_to_frpï¼‰å’Œè™šæ‹Ÿç¯å¢ƒ

**è¯´æ˜**ï¼šæŠŠè„šæœ¬æ”¾åˆ° `/opt/serial_to_frp`ï¼Œå»ºç«‹ venv å¹¶å®‰è£…ä¾èµ–ï¼Œè„šæœ¬ä¼šæŠŠä¸²å£æ•°æ®é€šè¿‡ MQTT å‘åˆ°å¯¹åº”çš„ ThingsBoard deviceï¼ˆtoken è§„åˆ™åœ¨è„šæœ¬ä¸­ï¼‰ã€‚

åˆ›å»ºç›®å½•ä¸è®¾ç½®æƒé™ï¼š

```bash
sudo mkdir -p /opt/serial_to_frp
sudo chown -R $USER:$USER /opt/serial_to_frp
```

åˆ›å»º venv å¹¶å®‰è£… Python åŒ…ï¼š

```bash
python3 -m venv /opt/serial_to_frp/venv
/opt/serial_to_frp/venv/bin/pip install --upgrade pip
/opt/serial_to_frp/venv/bin/pip install paho-mqtt pyserial
```

å°†å®Œæ•´ Python è„šæœ¬å†™å…¥æ–‡ä»¶ï¼š

```bash
sudo nano /opt/serial_to_frp/serial_to_frp.py
```

è¿›å…¥ç¼–è¾‘ç•Œé¢ï¼Œç²˜è´´ä¸‹æ–¹å®Œæ•´ä»£ç ï¼ŒCtrl+Oä¿å­˜ä¿®æ”¹ï¼ŒCtrl+Xé€€å‡º

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
serial_to_frp.py

åŠŸèƒ½ï¼š
  - ä»ä¸²å£è¯»å–ä¼ æ„Ÿå™¨/èŠ‚ç‚¹æ•°æ®
  - è§£æ CASE / CHASSIS / NODE ç­‰æ ¼å¼
  - æŒ‰ CASE å»ºç«‹ MQTT å®¢æˆ·ç«¯å¹¶é€šè¿‡ FRP éš§é“å‘é€é¥æµ‹ä¸å±æ€§

æ³¨æ„ï¼š
  - device_token è§„åˆ™:
      device_token = BASE_TOKEN_PREFIX + PROJECT_NO + "CASE" + 3ä½case_id
  - æœ¬è„šæœ¬åªæ›¿æ¢äº† parse_dataï¼Œä½¿å…¶æ›´å®½å®¹ã€å¥å£®ï¼Œèƒ½è¯†åˆ«åƒ
      CASE:1,Temp=29.31C, Smoke=42.73PPM
    è¿™ç§å¸¦ç©ºæ ¼ã€å•ä½çš„è¾“å…¥ã€‚
"""

import serial, time, json, re, threading
from collections import defaultdict
import queue, sys, glob, logging
import paho.mqtt.client as mqtt

# ---------------- logging ----------------
logging.basicConfig(
    level=logging.INFO,  # å¦‚éœ€è°ƒè¯•è§£æç»†èŠ‚ï¼ŒæŠŠè¿™é‡Œæ”¹ä¸º logging.DEBUG
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[logging.FileHandler("serial_to_frp.log"), logging.StreamHandler()]
)
logger = logging.getLogger(__name__)

# ===== è‡ªåŠ¨ä¸²å£æ£€æµ‹ =====
def find_serial_port():
    for pattern in ["/dev/ttyUSB*", "/dev/ttyACM*", "/dev/ttyS*"]:
        ports = glob.glob(pattern)
        if ports:
            ports.sort()
            return ports[0]
    return None

# ===== é…ç½®åŒºï¼ˆæŒ‰éœ€ä¿®æ”¹ï¼‰=====
SERIAL_PORT = find_serial_port()
BAUD_RATE = 115200

BASE_TOKEN_PREFIX = "UX4XLX1ZGZL416"
PROJECT_NO = "NO002"
# ===è¿™é‡ŒPROJECT_NOéœ€è¦æ ¹æ®ä¸åŒçš„é¡¹ç›®æ¥è¿›è¡Œä¿®æ”¹===

# æŒ‡å‘ test1 éš§é“ï¼ˆMQTTï¼‰
FRP_SERVER = "frp-rug.com"
FRP_PORT   = 10276

if SERIAL_PORT is None:
    logger.error("æœªæ‰¾åˆ°å¯ç”¨çš„ä¸²å£è®¾å¤‡; ç¨‹åºå°†é‡è¯•å¯åŠ¨ç”± systemd æ‹‰èµ·")
    sys.exit(1)

logger.info(f"ä½¿ç”¨ä¸²å£è®¾å¤‡: {SERIAL_PORT}")

# ===== å…¨å±€ =====
case_node_last_seen = defaultdict(lambda: defaultdict(float))
all_known_nodes = defaultdict(set)
mqtt_clients = {}

def get_mqtt_client(case_id):
    """
    ä¸ºæŒ‡å®š case_id è¿”å›ï¼ˆæˆ–åˆ›å»ºï¼‰å¯¹åº”çš„ MQTT å®¢æˆ·ç«¯å¹¶å¯åŠ¨ loopã€‚
    ä½¿ç”¨ device_token ä½œä¸ºç”¨æˆ·åè¿›è¡Œè®¤è¯ï¼ˆæ— å¯†ç ï¼‰ã€‚
    """
    if case_id not in mqtt_clients:
        device_token = f"{BASE_TOKEN_PREFIX}{PROJECT_NO}CASE{str(case_id).zfill(3)}"
        logger.info(f"åˆ›å»ºMQTTå®¢æˆ·ç«¯: CASE {case_id}, ä»¤ç‰Œ: {device_token}")
        client = mqtt.Client()
        client.username_pw_set(device_token)
        def on_connect(client, userdata, flags, rc):
            if rc == 0:
                logger.info(f"âœ… CASE {case_id} MQTTè¿æ¥æˆåŠŸ")
            else:
                logger.error(f"âŒ CASE {case_id} MQTTè¿æ¥å¤±è´¥ï¼Œé”™è¯¯ç : {rc}")
        client.on_connect = on_connect
        # éé˜»å¡è¿æ¥ï¼ˆloop_start() å¯åŠ¨çº¿ç¨‹ï¼‰
        client.connect(FRP_SERVER, FRP_PORT, 60)
        client.loop_start()
        mqtt_clients[case_id] = client
    return mqtt_clients[case_id]

# ===== æ•°æ®è§£æå‡½æ•° =====
def chassis_to_case(chassis_id: int) -> int:
    """
    å°† CHASSIS æ˜ å°„ä¸º CASEï¼š
      1/2 -> CASE 1, 3/4 -> CASE 2, 5/6 -> CASE 3, ä»¥æ­¤ç±»æ¨ã€‚
    """
    cid = int(chassis_id)
    return (cid + 1) // 2

def parse_data(raw_data: str):
    """
    æ›´ç¨³å¥çš„ä¸²å£æ•°æ®è§£æã€‚

    æ”¯æŒæ ¼å¼ï¼ˆå®½æ¾åŒ¹é…ï¼‰ï¼š
      - CASE:<n>,NODE:<m>,VOLT:<v>V,TEMP:<t>
      - CHASSIS:<n>,NODE:<m>,VOLT:<v>V,TEMP:<t>  (æ˜ å°„ä¸ºå¯¹åº” CASE)
      - CASE:<n>,Temp=<tt>C,Smoke=<ss>PPM
    ç‰¹æ€§ï¼š
      - å¿½ç•¥ä»¥ 'SensorData:' å¼€å¤´çš„è¡Œï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰
      - å…¼å®¹ : æˆ– = åˆ†éš”ï¼Œå…è®¸å­—æ®µé—´æœ‰ç©ºæ ¼æˆ–é€—å·åçš„ç©ºæ ¼
      - è‡ªåŠ¨å»é™¤å•ä½åç¼€ï¼ˆå¦‚ C / V / PPM / % ç­‰ï¼‰
      - è‹¥æ— æ³•ç”¨å®½æ¾æ–¹å¼è§£æï¼Œåˆ™å›é€€åˆ°ä¸¥æ ¼æ­£åˆ™ä»¥å…¼å®¹æ—§æ ¼å¼
    è¿”å›ï¼š
      list of dictï¼Œdict çš„ type ä¸º 'node' æˆ– 'case'ï¼Œå­—æ®µä¸åŸè„šæœ¬ä¸€è‡´
    """
    results = []
    if not raw_data:
        return results

    # é€è¡Œè§£æï¼Œé¿å…è·¨è¡Œæ‹¼æ¥å¯¼è‡´åŒ¹é…å¤±è´¥
    for line in raw_data.splitlines():
        s = line.strip()
        if not s:
            continue
        # å¿½ç•¥ SensorData: å¼€å¤´çš„è¡Œ
        if s.lower().startswith('sensordata:'):
            logger.debug(f"å¿½ç•¥è¡Œ (SensorData): {s}")
            continue

        # å®½æ¾çš„é”®å€¼å¯¹åŒ¹é…ï¼šKey :|= Number [units optional]
        # æ•è·å½¢å¼ä¾‹å¦‚ï¼š "Temp=29.31C" æˆ– "VOLT:12.3V" -> ('Temp','29.31') ; å¿½ç•¥å¤§å°å†™
        kv_pattern = r'([A-Za-z]+)\s*[:=]\s*([+-]?\d+(?:\.\d+)?)(?:[A-Za-z%]*)'
        matches = re.findall(kv_pattern, s, flags=re.IGNORECASE)
        kv_pairs = {k.upper(): v for k, v in matches}  # ç»Ÿä¸€ä¸ºå¤§å†™ key -> value(string)

        # è·å– case_idï¼šä¼˜å…ˆ CASEï¼Œå…¶æ¬¡ CHASSIS -> è½¬æ¢ä¸º CASE
        case_id = None
        if 'CASE' in kv_pairs:
            try:
                case_id = int(kv_pairs['CASE'])
            except Exception:
                case_id = None
        elif 'CHASSIS' in kv_pairs:
            try:
                case_id = chassis_to_case(int(kv_pairs['CHASSIS']))
            except Exception:
                case_id = None

        # 1) èŠ‚ç‚¹æ•°æ®ï¼šéœ€è¦ NODE, VOLT, TEMP ä¸‰ä¸ªå­—æ®µ
        if 'NODE' in kv_pairs and 'VOLT' in kv_pairs and 'TEMP' in kv_pairs:
            try:
                node_id = int(kv_pairs['NODE'])
                volt = float(kv_pairs['VOLT'])
                temp = float(kv_pairs['TEMP'])
                # å¦‚æœæœªåœ¨ kv_pairs å¾—åˆ° CASEï¼Œä½†è¡Œä¸­å¯èƒ½ä½¿ç”¨ CHASSIS æˆ–æ˜ç¡®å†™äº† CASEï¼ˆä¸Šé¢å·²å°è¯•ï¼‰
                # è‹¥ä»æœªæ‰¾åˆ° case_idï¼Œå°è¯•ä½¿ç”¨æ›´å®½æ¾çš„æ­£åˆ™å»æœ CASE:xx æˆ– CHASSIS:xx
                if case_id is None:
                    m_case = re.search(r'CASE\s*[:=]\s*(\d+)', s, re.IGNORECASE)
                    if m_case:
                        case_id = int(m_case.group(1))
                    else:
                        m_ch = re.search(r'CHASSIS\s*[:=]\s*(\d+)', s, re.IGNORECASE)
                        if m_ch:
                            case_id = chassis_to_case(int(m_ch.group(1)))
                if case_id is None:
                    # å¦‚æœä»ç„¶æ— æ³•ç¡®è®¤ CASEï¼Œè®°å½• debug å¹¶è·³è¿‡è¯¥è¡Œ
                    logger.debug(f"èŠ‚ç‚¹è¡Œæ— æ³•ç¡®å®š CASEï¼Œè·³è¿‡: {s}")
                else:
                    results.append({
                        'type': 'node',
                        'case_id': int(case_id),
                        'node_id': node_id,
                        'volt': volt,
                        'temp': temp
                    })
                    continue  # å¤„ç†ä¸‹ä¸€è¡Œ
            except Exception as e:
                logger.debug(f"è§£æèŠ‚ç‚¹è¡Œå‡ºé”™: {s} ; err: {e}")

        # 2) æœºç®±æ•°æ®ï¼šéœ€è¦è‡³å°‘ TEMP æˆ– SMOKEï¼Œå¹¶ä¸”æœ‰ CASEï¼ˆæˆ– CHASSISï¼‰
        if case_id is not None and ('TEMP' in kv_pairs or 'SMOKE' in kv_pairs):
            try:
                temp = float(kv_pairs.get('TEMP')) if 'TEMP' in kv_pairs else None
                smoke = float(kv_pairs.get('SMOKE')) if 'SMOKE' in kv_pairs else None
                # è‹¥æ²¡æœ‰æŸä¸ªå€¼ï¼ŒæŒ‰åŸè„šæœ¬æƒ¯ä¾‹ä¼  0.0ï¼ˆä¹Ÿå¯é€‰æ‹©è·³è¿‡ï¼‰
                results.append({
                    'type': 'case',
                    'case_id': int(case_id),
                    'temp': temp if temp is not None else 0.0,
                    'smoke': smoke if smoke is not None else 0.0
                })
                continue
            except Exception as e:
                logger.debug(f"è§£ææœºç®±è¡Œå‡ºé”™: {s} ; err: {e}")

        # 3) å›é€€ï¼šå°è¯•åŸæœ‰æ›´ä¸¥æ ¼çš„æ­£åˆ™ï¼ˆå…¼å®¹æ—§è¾“å…¥ï¼‰
        # èŠ‚ç‚¹ï¼ˆCASE:1,NODE:2,VOLT:12.3V,TEMP:36.1ï¼‰
        node_pat_case = r'CASE\s*[:=]\s*(\d+)\s*,\s*NODE\s*[:=]\s*(\d+)\s*,\s*VOLT\s*[:=]\s*([\d.]+)V\s*,\s*TEMP\s*[:=]\s*([+-]?\d+(?:\.\d+)?)'
        m_node_case = re.search(node_pat_case, s, re.IGNORECASE)
        if m_node_case:
            try:
                case_id_r = int(m_node_case.group(1))
                node_id = int(m_node_case.group(2))
                volt = float(m_node_case.group(3))
                temp = float(m_node_case.group(4))
                results.append({
                    'type': 'node',
                    'case_id': case_id_r,
                    'node_id': node_id,
                    'volt': volt,
                    'temp': temp
                })
                continue
            except Exception:
                pass

        # CHASSIS èŠ‚ç‚¹ï¼ˆå›é€€ï¼‰
        node_pat_chassis = r'CHASSIS\s*[:=]\s*(\d+)\s*,\s*NODE\s*[:=]\s*(\d+)\s*,\s*VOLT\s*[:=]\s*([\d.]+)V\s*,\s*TEMP\s*[:=]\s*([+-]?\d+(?:\.\d+)?)'
        m_node_chassis = re.search(node_pat_chassis, s, re.IGNORECASE)
        if m_node_chassis:
            try:
                chassis_id = int(m_node_chassis.group(1))
                case_id_r = chassis_to_case(chassis_id)
                node_id = int(m_node_chassis.group(2))
                volt = float(m_node_chassis.group(3))
                temp = float(m_node_chassis.group(4))
                results.append({
                    'type': 'node',
                    'case_id': case_id_r,
                    'node_id': node_id,
                    'volt': volt,
                    'temp': temp
                })
                continue
            except Exception:
                pass

        # åŸæœ‰ CASE æœºç®±ä¸¥æ ¼æ¨¡å¼ï¼šCASE:1,Temp=29.31C,Smoke=42.73PPM
        case_pat = r'CASE\s*[:=]\s*(\d+)\s*,\s*Temp\s*[=:\s]\s*([\d.]+)C\s*,\s*Smoke\s*[=:\s]\s*([\d.]+)PPM'
        m_case = re.search(case_pat, s, re.IGNORECASE)
        if m_case:
            try:
                results.append({
                    'type': 'case',
                    'case_id': int(m_case.group(1)),
                    'temp': float(m_case.group(2)),
                    'smoke': float(m_case.group(3))
                })
                continue
            except Exception:
                pass

        # æœªè¯†åˆ«è¡Œï¼ˆè®°å½• debugï¼Œä¾¿äºå®šä½ï¼‰
        logger.debug(f"æœªè¯†åˆ«çš„ä¸²å£è¡Œ: {s}")

    return results

# ===== æ•°æ®å¤„ç†å‡½æ•° =====
def process_node(case_id, node_id, volt, temp):
    """
    å¤„ç†å•ä¸ªèŠ‚ç‚¹æ•°æ®ï¼šæ›´æ–°æœ€åè§åˆ°æ—¶é—´ã€å‘ç°æ–°èŠ‚ç‚¹æ—¶è®°å½•ã€å¹¶é€šè¿‡ MQTT å‘å¸ƒé¥æµ‹
    """
    case_node_last_seen[case_id][node_id] = time.time()
    if node_id not in all_known_nodes[case_id]:
        logger.info(f"å‘ç°æ–°èŠ‚ç‚¹: CASE {case_id}, NODE {node_id}")
        all_known_nodes[case_id].add(node_id)
    client = get_mqtt_client(case_id)
    telemetry = { f"èŠ‚ç‚¹{node_id}ç”µå‹": volt, f"èŠ‚ç‚¹{node_id}æ¸©åº¦": temp }
    try:
        # publish è¿”å› MQTTMessageInfo å¯¹è±¡ï¼Œæ£€æŸ¥ rc
        r = client.publish("v1/devices/me/telemetry", json.dumps(telemetry), qos=1)
        # å¦‚æœéœ€è¦æ›´ä¸¥æ ¼åœ°ç­‰å¾…å‘é€å®Œæˆå¯ä»¥ä½¿ç”¨ r.wait_for_publish()
        if getattr(r, "rc", None) == mqtt.MQTT_ERR_SUCCESS:
            logger.info(f"âœ… CASE {case_id} èŠ‚ç‚¹{node_id}é¥æµ‹å‘é€æˆåŠŸ")
        else:
            logger.error(f"âŒ CASE {case_id} èŠ‚ç‚¹{node_id}å‘é€å¤±è´¥: {getattr(r, 'rc', 'unknown')}")
    except Exception as e:
        logger.error(f"âŒ CASE {case_id} èŠ‚ç‚¹{node_id}å¼‚å¸¸: {e}")

def process_case(case_id, temp, smoke):
    """
    å¤„ç†æœºç®±æ•°æ®ï¼šé€šè¿‡ MQTT å‘å¸ƒæœºç®±æ¸©åº¦ä¸çƒŸé›¾æµ“åº¦
    """
    client = get_mqtt_client(case_id)
    telemetry = {"æœºç®±æ¸©åº¦": temp, "çƒŸé›¾æµ“åº¦": smoke}
    try:
        r = client.publish("v1/devices/me/telemetry", json.dumps(telemetry), qos=1)
        if getattr(r, "rc", None) == mqtt.MQTT_ERR_SUCCESS:
            logger.info(f"âœ… CASE {case_id} æœºç®±é¥æµ‹å‘é€æˆåŠŸ")
        else:
            logger.error(f"âŒ CASE {case_id} æœºç®±é¥æµ‹å‘é€å¤±è´¥: {getattr(r, 'rc', 'unknown')}")
    except Exception as e:
        logger.error(f"âŒ CASE {case_id} æœºç®±å¼‚å¸¸: {e}")

def update_node_status(case_id):
    """
    å®šæœŸæ›´æ–°èŠ‚ç‚¹åœ¨çº¿/ç¦»çº¿å±æ€§å¹¶é€šè¿‡ attributes å‘å¸ƒ
    """
    now = time.time()
    status = {}
    for node_id in all_known_nodes[case_id]:
        is_online = (now - case_node_last_seen[case_id].get(node_id,0)) <= 120
        status[f"èŠ‚ç‚¹{node_id}"] = "åœ¨çº¿" if is_online else "ç¦»çº¿"
    client = get_mqtt_client(case_id)
    try:
        r = client.publish("v1/devices/me/attributes", json.dumps(status), qos=1)
        if getattr(r, "rc", None) == mqtt.MQTT_ERR_SUCCESS:
            logger.info(f"âœ… CASE {case_id} èŠ‚ç‚¹çŠ¶æ€å±æ€§å‘é€æˆåŠŸ")
        else:
            logger.error(f"âŒ CASE {case_id} èŠ‚ç‚¹çŠ¶æ€å±æ€§å‘é€å¤±è´¥: {getattr(r, 'rc', 'unknown')}")
    except Exception as e:
        logger.error(f"âŒ CASE {case_id} å±æ€§å‘é€å¼‚å¸¸: {e}")

def check_node_status():
    """
    åå°çº¿ç¨‹ï¼šæ¯åˆ†é’Ÿæ£€æŸ¥æ‰€æœ‰ case çš„èŠ‚ç‚¹çŠ¶æ€å¹¶æ›´æ–° attributes
    """
    while True:
        try:
            for case_id in list(case_node_last_seen.keys()):
                update_node_status(case_id)
            time.sleep(60)
        except Exception as e:
            logger.error(f"æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€æ—¶å‡ºé”™: {e}")
            time.sleep(10)

def monitor_mqtt():
    """
    åå°çº¿ç¨‹ï¼šå®šæœŸæ£€æŸ¥ MQTT å®¢æˆ·ç«¯è¿æ¥çŠ¶æ€ï¼Œå°è¯•é‡è¿
    """
    while True:
        try:
            for case_id, client in list(mqtt_clients.items()):
                if not client.is_connected():
                    logger.warning(f"âš ï¸ CASE {case_id} MQTTæ–­å¼€ï¼Œé‡è¿")
                    try:
                        client.reconnect()
                    except Exception as e:
                        logger.error(f"âŒ CASE {case_id} é‡è¿å¤±è´¥: {e}")
            time.sleep(30)
        except Exception as e:
            logger.error(f"è¿æ¥ç›‘æ§å‡ºé”™: {e}")
            time.sleep(10)

def main():
    """
    ä¸»å¾ªç¯ï¼šæ‰“å¼€ä¸²å£ã€è¯»å–æ•°æ®ã€ç´¯ç§¯ç¼“å†²ã€æŒ‰è¶…æ—¶æˆ–å®Œæ•´è§£æè§¦å‘ä¸ŠæŠ¥
    """
    try:
        ser = serial.Serial(SERIAL_PORT, BAUD_RATE, bytesize=serial.EIGHTBITS,
                            parity=serial.PARITY_NONE, stopbits=serial.STOPBITS_ONE, timeout=1)
        ser.flushInput()
        logger.info(f"å¼€å§‹ç›‘å¬ä¸²å£ {SERIAL_PORT}ï¼Œæ³¢ç‰¹ç‡ {BAUD_RATE}...")
        # å¯åŠ¨åå°çº¿ç¨‹
        threading.Thread(target=check_node_status, daemon=True).start()
        threading.Thread(target=monitor_mqtt, daemon=True).start()

        buf, last = "", time.time()
        while True:
            # æœ‰æ•°æ®æ—¶è¯»å–å¹¶è¿½åŠ åˆ°ç¼“å†²
            if ser.in_waiting > 0:
                raw = ser.read(ser.in_waiting).decode('utf-8', errors='ignore')
                buf += raw
                last = time.time()
                if raw.strip():
                    logger.info(f"æ”¶åˆ°åŸå§‹æ•°æ®: {repr(raw)}")
                parsed = parse_data(buf)
                if parsed:
                    # æŒ‰ case èšåˆå¹¶å¤„ç†
                    grouped = defaultdict(list)
                    for d in parsed:
                        grouped[d['case_id']].append(d)
                    for case_id, items in grouped.items():
                        logger.info(f"å¤„ç† CASE {case_id} æ•°æ®ï¼Œå…± {len(items)} æ¡")
                        for d in items:
                            if d['type'] == 'node':
                                process_node(d['case_id'], d['node_id'], d['volt'], d['temp'])
                                update_node_status(d['case_id'])
                            else:
                                process_case(d['case_id'], d['temp'], d['smoke'])
                    # å¤„ç†åæ¸…ç©ºç¼“å†²ï¼ˆè‹¥ä½ çš„ä¸²å£å¯èƒ½æœ‰å¤šæ¡ç‹¬ç«‹æ¶ˆæ¯ä½†ä¸å«æ¢è¡Œï¼Œéœ€è¦æŒ‰éœ€ä¿®æ”¹ï¼‰
                    buf = ""

            # è¶…æ—¶å¤„ç†ï¼ˆ0.5s æ— æ–°æ•°æ®åˆ™å°è¯•è§£æç°æœ‰ç¼“å†²ï¼‰
            if time.time() - last > 0.5 and buf:
                parsed = parse_data(buf)
                grouped = defaultdict(list)
                for d in parsed:
                    grouped[d['case_id']].append(d)
                for case_id, items in grouped.items():
                    logger.info(f"è¶…æ—¶å¤„ç† CASE {case_id} å…± {len(items)} æ¡")
                    for d in items:
                        if d['type'] == 'node':
                            process_node(d['case_id'], d['node_id'], d['volt'], d['temp'])
                            update_node_status(d['case_id'])
                        else:
                            process_case(d['case_id'], d['temp'], d['smoke'])
                buf = ""
                last = time.time()

            time.sleep(0.1)

    except KeyboardInterrupt:
        logger.info("ç”¨æˆ·ä¸­æ–­")
    except Exception as e:
        logger.error(f"ç¨‹åºè¿è¡Œå‡ºé”™: {e}")
    finally:
        try:
            ser.close()
            logger.info("âœ… ä¸²å£å·²å…³é—­")
        except Exception:
            pass
        for case_id, client in mqtt_clients.items():
            try:
                client.disconnect()
                logger.info(f"âœ… CASE {case_id} MQTTå…³é—­")
            except Exception:
                pass
        logger.info("ğŸ¯ é€€å‡º")

if __name__ == "__main__":
    main()

```

æœ€åä¸€æ­¥èµ‹äºˆå¯æ‰§è¡Œæƒé™ï¼š

```bash
sudo chmod +x /opt/serial_to_frp/serial_to_frp.py
```



#### 3.2.11 systemd å•å…ƒï¼šä¸²å£è„šæœ¬ã€ThingsBoard Stack æœåŠ¡

serial_to_frp systemdï¼ˆéšå¼€æœºè‡ªå¯ï¼‰

```bash
sudo tee /etc/systemd/system/serial_to_frp.service > /dev/null <<'UNIT'
[Unit]
Description=Serial to ThingsBoard via FRP
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=root
ExecStart=/opt/serial_to_frp/venv/bin/python /opt/serial_to_frp/serial_to_frp.py
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
UNIT
```

å¯ç”¨å¹¶å¯åŠ¨ï¼š

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now serial_to_frp
sudo systemctl status serial_to_frp --no-pager -n 20
```

tb-stack systemdï¼ˆç”¨ systemd ç®¡ç† docker composeï¼‰

**è¯´æ˜**ï¼šæŠŠ `docker compose up -d` æ”¾å…¥ oneshot æœåŠ¡ï¼Œéšå¼€æœºå¯åŠ¨ ThingsBoard Stackã€‚

```bash
sudo tee /etc/systemd/system/tb-stack.service > /dev/null <<'UNIT'
[Unit]
Description=ThingsBoard Stack (docker compose)
After=docker.service network-online.target
Wants=docker.service network-online.target

[Service]
Type=oneshot
WorkingDirectory=/home/pi/tb-stack
ExecStart=/usr/bin/docker compose up -d
ExecStop=/usr/bin/docker compose down
RemainAfterExit=yes
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
UNIT
```

å¯ç”¨å¹¶å¯åŠ¨ï¼š

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now tb-stack
sudo systemctl status tb-stack --no-pager
```

#### 3.2.12 ä¸€é”®ä½¿æœåŠ¡éšå¼€æœºå¯åŠ¨ & é‡å¯éªŒè¯

**è¯´æ˜**ï¼šæŠŠå¸¸ç”¨æœåŠ¡ä¸€æ¬¡æ€§ enable å¹¶é‡å¯éªŒè¯ç³»ç»Ÿå¯åŠ¨é¡¹ã€‚

```bash
sudo systemctl enable --now frpc@test1 frpc@test2 serial_to_frp caddy docker
```

å»ºè®®æ‰‹åŠ¨é‡å¯å¹¶æ£€æŸ¥å„æœåŠ¡çŠ¶æ€ï¼š

```bash
sudo reboot
```

é‡å¯åæ£€æŸ¥æœåŠ¡ï¼š

```bash
sudo systemctl status frpc@test1 --no-pager -l
sudo systemctl status frpc@test2 --no-pager -l
sudo systemctl status serial_to_frp --no-pager -l
sudo systemctl status caddy --no-pager -l
sudo systemctl status docker --no-pager -l
```

## **è‡³æ­¤å®Œæˆæ‰€æœ‰çš„é…ç½®æ­¥éª¤**ğŸ”š

#### å¸¸è§éªŒè¯ä¸æ•…éšœæ’æŸ¥å‘½ä»¤

- æŸ¥çœ‹ docker æ—¥å¿— / å®¹å™¨çŠ¶æ€ï¼š

```bash
docker ps -a
docker logs <container> --tail 200
```

- æŸ¥çœ‹ journal æ—¥å¿—ï¼ˆCaddy/Frp/serialï¼‰ï¼š

```bash
sudo journalctl -u caddy -n 200 --no-pager
sudo journalctl -u frpc@test1 -n 200 --no-pager
sudo journalctl -u serial_to_frp -n 200 --no-pager
```

- æ£€æŸ¥ç«¯å£ç›‘å¬ï¼ˆç¡®è®¤ 8080/1883/8443 æ˜¯å¦å°±ç»ªï¼‰ï¼š

```bash
sudo ss -tulpn | grep -E '8080|1883|8443'
```

- æœ¬æœº curl å¥åº·æ£€æŸ¥ï¼ˆThingsBoardï¼‰ï¼š

```bash
curl -sS http://127.0.0.1:9090/api/health ; echo
```
